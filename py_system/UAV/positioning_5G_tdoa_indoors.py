#!/usr/bin/python3
# -*- coding: utf-8 -*-

import os
import sys
import math
import re
import random
import numpy as np
import matplotlib.pyplot as plt
from numpy.linalg import inv
import scipy.constants as spy_constants
from uav_tdoa import Sim2DCord
from scipy.optimize import fsolve
from scipy.optimize import leastsq

class Sim3DCord(object):
    def __init__(self, x, y, z=0):
        self.x = x
        self.y = y
        self.z = z

    def calc_distance(self, dest):
        return math.sqrt((self.x - dest.x)**2 + (self.y - dest.y)**2 + (self.z - dest.z)**2)
 
    def debug_print(self):
        print('Coordinate is : %.6f, %.6f, %.6f' % (self.x, self.y, self.z))

# From : 3D TDOA Problem Solution with Four Receiving Nodes, J. D. Gonzalez, R. Alvarez, etc., 27 June, 2019.
# dt21 : UE to bs2 and bs1 TOA difference
# dt31 : UE to bs3 and bs1 TOA difference
# dt41 : UE to bs4 and bs1 TOA difference
def tdoa_positioning_4bs_improve(bs1, bs2, bs3, bs4, dt21, dt31, dt41, x_init, y_init, z_init, method='newton'):
    position = Sim3DCord(0.0, 0.0, 0.0)
    light_speed = spy_constants.speed_of_light
    def equations_3d(p):
        x, y, z = p
        r1 = math.sqrt((x-bs1.x)**2 + (y-bs1.y)**2 + (z-bs1.z)**2)
        r2 = math.sqrt((x-bs2.x)**2 + (y-bs2.y)**2 + (z-bs2.z)**2)
        r3 = math.sqrt((x-bs3.x)**2 + (y-bs3.y)**2 + (z-bs3.z)**2)
        r4 = math.sqrt((x-bs4.x)**2 + (y-bs4.y)**2 + (z-bs4.z)**2)
        return (r2 - r1 - light_speed*dt21, r3 - r1 - light_speed*dt31, r4 - r1 - light_speed*dt41)
    
    def taylor_solver(bs1, bs2, bs3, bs4, L, R, U):
        x = 0
        y = 0
        z = 0
        XL = bs2.x - bs1.x
        YL = bs2.y - bs1.y
        ZL = bs2.z - bs1.z
        XR = bs3.x - bs1.x
        YR = bs3.y - bs1.y
        ZR = bs3.z - bs1.z
        XU = bs4.x - bs1.x
        YU = bs4.y - bs1.y
        ZU = bs4.z - bs1.z
        E = L*L - XL*XL - YL*YL - ZL*ZL
        F = R*R - XR*XR - YR*YR - ZR*ZR
        G = U*U - XU*XU - YU*YU - ZU*ZU
        delta = -8 * (XL*YR*ZU+XU*YL*ZR+XR*YU*ZL-XL*YU*ZR-XR*YL*ZU-XU*YR*ZL)
        delta1 = 4*(YR*ZU-YU*ZR)
        delta2 = 4*(YL*ZU-YU*ZL)
        delta3 = 4*(YL*ZR-YR*ZL)
        # print("delta := ", delta, delta1, delta2, delta3)
        MX = (2/delta)*(L*delta1-R*delta2+U*delta3)
        NX = (1/delta)*(E*delta1-F*delta2+G*delta3)
        # print("MX, NX := ", MX, NX)
        delta1 = 4*(XR*ZU-XU*ZR)
        delta2 = 4*(XL*ZU-XU*ZL)
        delta3 = 4*(XL*ZR-XR*ZL)
        MY = (2/delta)*(-L*delta1+R*delta2-U*delta3)
        NY = (1/delta)*(-E*delta1+F*delta2-G*delta3)
        # print("MY, NY := ", MY, NY)
        delta1 = 4*(XR*YU-XU*YR)
        delta2 = 4*(XL*YU-XU*YL)
        delta3 = 4*(XL*YR-XR*YL)
        MZ = (2/delta)*(L*delta1-R*delta2+U*delta3)
        NZ = (1/delta)*(E*delta1-F*delta2+G*delta3)
        
        a = MX*MX+MY*MY+MZ*MZ - 1
        b = 2*(MX*NX+MY*NY+MZ*NZ)
        c = NX*NX+NY*NY+NZ*NZ

        if (b*b-4*a*c) < 0:
            x = np.NaN
            y = np.NaN
            z = np.NaN
            return x, y, z

        k1 = (-b + np.sqrt(b*b-4*a*c))/(2*a)
        k2 = (-b - np.sqrt(b*b-4*a*c))/(2*a)
        
        x1 = MX*k1+NX+bs1.x
        y1 = MY*k1+NY+bs1.y
        z1 = MZ*k1+NZ+bs1.z
        x2 = MX*k2+NX+bs1.x
        y2 = MY*k2+NY+bs1.y
        z2 = MZ*k2+NZ+bs1.z
        
        if k2 < 0:
            x = x1
            y = y1
            z = z1
        else:
            r_ref = math.sqrt((x1-bs1.x)**2+(y1-bs1.y)**2+(z1-bs1.z)**2)
            r2_ref = math.sqrt((x1-bs2.x)**2+(y1-bs2.y)**2+(z1-bs2.z)**2)
            r3_ref = math.sqrt((x1-bs3.x)**2+(y1-bs3.y)**2+(z1-bs3.z)**2)
            r4_ref = math.sqrt((x1-bs4.x)**2+(y1-bs4.y)**2+(z1-bs4.z)**2)
            sum1 = ((r2_ref - r_ref) - L)**2 + ((r3_ref - r_ref) - R)**2 + ((r4_ref - r_ref) - U)**2
            
            r_ref2 = math.sqrt((x2-bs1.x)**2+(y2-bs1.y)**2+(z2-bs1.z)**2)
            r2_ref2 = math.sqrt((x2-bs2.x)**2+(y2-bs2.y)**2+(z2-bs2.z)**2)
            r3_ref2 = math.sqrt((x2-bs3.x)**2+(y2-bs3.y)**2+(z2-bs3.z)**2)
            r4_ref2 = math.sqrt((x2-bs4.x)**2+(y2-bs4.y)**2+(z2-bs4.z)**2)
            sum2 = ((r2_ref2 - r_ref2) - L)**2 + ((r3_ref2 - r_ref2) - R)**2 + ((r4_ref2 - r_ref2) - U)**2
            
            if sum1 < sum2 and (x1 > 0) and (y1 > 0) and (z1>0):
                x = x1
                y = y1
                z = z1
            else:
                x = x2
                y = y2
                z = z2
        return x, y, z
    
    def scipy_3d_solver():
        if method.lower() == 'newton':
            x_est, y_est, z_est = fsolve(equations_3d, (x_init, y_init, z_init), maxfev=2000)
        elif method.lower() == 'taylor-direct':
            # print("Use the taylor-direct method ...")
            r21 = light_speed * dt21
            r31 = light_speed * dt31
            r41 = light_speed * dt41
            x_est, y_est, z_est = taylor_solver(bs1, bs2, bs3, bs4, r21, r31, r41)
        else:
            x = leastsq(equations_3d, (x_init, y_init, z_init))
            x_est = x[0][0]
            y_est = x[0][1]
            z_est = x[0][2]
        # print("solver() results : (%.6f, %.6f, %.6f)" % (x_est, y_est, z_est))
        if (np.isnan(x_est) or np.isnan(y_est) or np.isnan(z_est)):
            x_est, y_est, z_est = fsolve(equations_3d, (x_init, y_init, z_init), maxfev=1000)
            # print("solver() results (through modified) : (%.6f, %.6f, %.6f)" % (x_est, y_est, z_est))
        return x_est, y_est, z_est
    x_est, y_est, z_est = scipy_3d_solver()
    position.x = x_est
    position.y = y_est
    position.z = z_est
    return position

TX_POWER = 80

def signal2distance(sig, mode):
    if mode == 0:
        return 10**((TX_POWER - sig - 32.4 - 20 * np.log10(2.6)) / 17.3)
    elif mode == 1:
        return 10**((TX_POWER - sig - 28 - 20 * np.log10(2.6)) / 22)
    else:
        return 0.

def find_most_average(e_list):
    size = np.size(e_list)
    near_counter = np.zeros(np.size(e_list), dtype=int)
    for i in range(size):
        e = e_list[i]
        for k in range(size):
            if abs(e-e_list[k]) < 5.0:
                near_counter[i] += 1
    indices = near_counter.argmax()
    basic_value = e_list[indices]
    average = 0.
    counter = 0
    for i in range(size):
        if abs(e_list[i] - basic_value) < 5.0:
            average += e_list[i]
            counter += 1
    return average / counter

if __name__ == "__main__":
    print("Positioning test")
    light_speed = spy_constants.speed_of_light
    print('Indoors simulation !')
    bs1 = Sim3DCord(10, 19, 6)
    bs2 = Sim3DCord(1, 1, 8)
    bs3 = Sim3DCord(19, 1, 10)
    bs4 = Sim3DCord(5, 10, 4)
    ue = '3.9066562784943937, 10.700577388641417, 6.370442577296704, 14.241608427732801, 11.052379382044268, 10.946076922181609, 7.814981107526191, 15.1937877845341, 17.526480184954025, 13.992593432242861, 11.370873275225847, 8.776721019489244, 4.289620825606592, 18.32568099304383, 4.745297924707693, 8.385151736085724, 4.393927199231465, 8.201573191262595, 12.520952786557451, 2.944359324554915, 5.534573094522824, 8.118611456414131, 0.361998463580564, 3.9750550908868076, 3.0714905570030715, 3.8342531865728025, 17.511174212284352, 8.655712504909497, 9.085080475194026, 10.559815867633173, 10.694663165205991, 18.143032024072284, 18.648847588094025, 0.046986392460142135, 16.666455187548884, 3.361038685058186, 8.696158332911661, 8.74882845700795, 13.86407939079844, 5.7932732778243, 18.506702748076428, 17.259808108384554, 1.697962987246029, 10.944808979453901, 13.8834310451025, 8.65570596490858, 8.168347097330697, 19.71949302787014, 15.685845942712024, 15.431279714374146, 18.389494119500597, 5.232930159028751, 0.09729807589662798, 4.358113219698753, 3.34514036595271, 17.18117573404536, 15.73495991383089, 15.715532484863711, 8.023505334347343, 6.750176482983399, 19.805972505098957, 10.167923591443222, 3.0833625748407916, 15.622452629229977, 19.230661586914014, 12.137959141118191, 4.81144400802534, 4.928928171206584, 13.20370806938933, 18.80741119243255, 16.198461003703898, 6.5037991987319455, 4.4998025830996085, 11.275360943132757, 11.52845729759965, 7.061630867614319, 9.786154004366265, 19.394738479131558, 8.64425752365786, 2.0121975659196756, 6.526271518007148, 5.528115913041718, 2.736092746944856, 16.419726496197768, 2.4491383228838925, 6.974719713612552, 19.84577419498315, 0.9409418025666416, 0.9510549933600765, 2.619559493661299, 16.6886189655273, 0.03273923473554152, 19.87256722057375, 3.622066120447369, 16.74183567480249, 17.42661508719243, 6.88924440619342, 12.686557167033838, 12.009602340174917, 13.863138235717143, 9.780109002532143, 10.442670109659232, 4.127684694225722, 18.80415311864468, 17.860042378391327, 16.985656661800522, 11.001885650235845, 5.302895880803953, 0.7333154469436498, 17.08523087382184, 3.6307336817788616, 2.947482289051422, 9.778447030894416, 12.933479272319122, 9.954644557678185, 19.969553789021507, 7.980167290719598, 12.181690861006782, 0.49746241264086555, 2.210789768671983, 7.974844899038156, 7.844602537795153, 4.744663962816552, 1.802189721673575, 7.611481078285225, 18.260071213772132, 9.777938509030111, 5.41620417822108, 14.619231445497789, 11.687727241422095, 11.598191388202508, 7.242288112603948, 13.535910165064838, 13.24785013095081, 10.481132948385087, 9.650061671451484, 10.334382887555684, 12.535699264174534, 5.40382299973186, 11.271447761965765, 17.847252082497064, 5.711992748350891, 7.6943848302649265, 3.245665330118004, 19.855851102624303, 7.8209694871560576, 17.259379396902094, 8.696377589650979, 11.031489974401056, 19.276223741722482, 13.328866798739496, 9.37920003165167, 8.181120183100102, 11.341985681457544, 12.439282967998928, 16.61404533960566, 9.530621862574762, 12.51837678925369, 3.9868321777476807, 0.6101437777795882, 8.00824988872036, 7.793925745354272, 1.6776352195690092, 11.73714843820251, 7.838840252270455, 5.321320893052315, 9.963080304471132, 10.104775806540282, 5.053548841991078, 13.161848591158806, 4.361211425428531, 5.996493545876285, 10.907617955318266, 8.657562410904074, 9.553768481532234, 10.461433622663307, 18.610723927827916, 11.333489878539627, 0.39618575482211593, 5.1603801495581125, 9.991583344519485, 11.950387038146763, 19.832436407970633, 7.697683510478428, 11.45301698838212, 14.208164464751304, 16.219428961364986, 10.014801685607516, 19.498528809777568, 5.442245887539676, 6.175516812438313, 19.1236736493257, 13.948744523440272, 7.978474285773096, 9.487319634050383, 6.977860520178265, 17.94590508387352, 11.109899228255179, 18.54500351913854, 10.412409270287785, 16.42436212770155, 9.805826796592193, 15.59977014835706, 12.469593327950562, 0.12167889382737274, 5.2310215959091995, 13.111334780865073, 4.238843379129951, 1.8385700981891584, 12.927281492278471, 12.92196712225391, 8.665002425541902, 2.919810755774332, 7.294890813809682, 6.598564154586837, 13.978634206474704, 6.282572463720619, 17.713025839728584, 16.928373726891895, 8.245260075979006, 12.439208640052062, 4.54468617997501, 4.064769068000982, 3.214440567246537, 11.520929681689463, 0.1837460814531222, 9.258844678273217, 17.16734759972912, 7.838921292489401, 9.633199063202815, 15.529891827379815, 18.5604099109839, 1.6573547928334964, 16.32827943669841, 17.85254203305222, 0.21832781785028343, 7.061711020621161, 14.59455277183795, 5.939311890310512, 6.322630603518035, 18.58276370745113, 0.5011028911350857, 13.491535185311983, 4.416472292689042, 18.762385315502804, 3.103327731262528, 0.01568627245010834, 8.628276684878703, 16.954615033955022, 18.836948800123217, 4.043850647711434, 17.466250538193947, 14.685213183496504, 14.803858521822963, 3.2825776938545923, 18.036550266929687, 1.2334255756834689, 14.36586260553767, 8.12350116350352, 18.726638854929526, 2.7952575858082076, 7.31458061028313, 8.982496909699584, 17.567807103974296, 5.6296835963713265, 15.129225774777984, 15.264827489167406, 14.149515831788946, 4.496452534337012, 10.095804250526397, 15.86429124742579, 19.925652443182965, 14.063152634711056, 12.390314255088201, 19.833566826281373, 17.29090782371408, 6.897470535632905, 6.169407150442914, 2.3934543474145498, 11.865814102337255, 8.649936349458429, 17.900196578043804, 16.88672170181462, 2.112982260806968, 12.229796402033157, 3.2448674462267046, 3.8641818216053525, 16.12638620485191, 3.370025785043458, 15.814987734336741, 11.77349479872045, 8.649126137126885, 11.065128344697879, 4.008395459038911, 0.06534701216303507, 16.399849245686564, 5.905558286886006, 11.821211208003755, 2.0366995536767507, 18.322603178363703, 19.095997800934548, 12.763058433286794, 15.997364552926678, 18.020009441288863, 15.38057183576287, 18.628161261405875, 5.319477406471593, 18.33419282180308, 15.403691300818183, 8.445796864527848, 16.02361117779142, 15.721665171441627, 0.8213061391945597, 2.96742249040699, 18.80488889315374, 15.414099160638377, 18.118713034904783, 14.62050675554424, 12.800464322994136, 13.942460501535416, 5.587932308911272, 5.612318384594381, 4.861677985598201, 16.79829084816198, 2.6079034161832326, 0.9224161985717294, 17.130216450927744, 10.024040245008724, 8.941932308866932, 3.5582831857549504, 15.804983516764475, 10.752319502419441, 13.951768685600452, 17.44508631537083, 12.286026247384497, 10.070421605261028, 1.896538151385938, 10.533266232646117, 10.99956899307586, 5.606203395081404, 5.859235169793553, 15.955472266709126, 1.3598613743745958, 9.193486586659308, 6.308128556826749, 17.23526776130544, 10.774829188769106, 14.172007812575274, 13.417724511822334, 7.458163440356378, 8.131364843287486, 10.623456385534762, 5.0471707830312, 2.7611406421015823, 11.170449730184593, 12.841961686796672, 2.1737317578764035, 10.805617864926786, 16.131930690860706, 6.4229014705237955, 2.2620800756437065, 18.87594256176628, 17.94081492708213, 0.10612306754840928, 13.94356673010684, 19.875802103713877, 17.321233696307363, 8.177183341074867, 14.687665645730828, 17.413400498554424, 18.95308022814212, 19.279791310915897, 17.680819675278187, 0.43700477286983563, 19.96213085526023, 4.879559678980119, 15.427926140271154, 16.302889936920476, 3.581262087917314, 17.232888888863712, 17.92334020216101, 7.582670821246948, 7.37480366914834, 18.218120273239407, 9.299748672574246, 19.31471565798501, 8.528599353967266, 6.168492950831488, 11.550479156818053, 13.524783562696664, 17.92277778327711, 12.176592669673926, 14.08419568385919, 10.624969185614571, 0.9921953823149532, 14.194058002729614, 4.694234482391188, 12.62624031010008, 3.556428990973105, 0.5349903446051996, 0.8101773667358225, 13.154883568734496, 19.072587787366714, 11.910957478222414, 17.258322769486284, 15.529148287005247, 0.9747214837662299, 9.157194428191325, 11.460948319561199, 11.834596027537291, 3.523668032295886, 0.4822622853952496, 10.53094757845745, 19.49587697038341, 16.140060810244904, 4.948714766946251, 6.872990153834502, 16.622922786700673, 10.263905376854456, 10.42188702123102, 8.60101070774598, 18.263341615627443, 4.864502657557811, 6.205293442296494, 12.337636294856368, 5.983338562336928, 0.9375190912160924, 16.906816076191657, 12.31307930515327, 0.9097482178578242, 0.7160167175918342, 15.16015947692383, 7.7609651583321115, 13.007380352061064, 12.495754061441051, 19.177740159809083, 19.113835818602908, 15.406334370692285, 5.935042362563374, 3.539868926964318, 7.703170536743262, 2.3173040706909354, 10.273802349556345, 2.3193828646559864, 14.350217115722009, 8.445637766816434, 3.893552611126582, 9.365823416731933, 19.54129264527603, 15.270237491365737, 1.5123245567405097, 2.642138291194067, 6.53717562596197, 8.727362095802613, 2.0013753970808534, 2.243386765873981, 2.637081460373716, 17.946803111791233, 7.079537271338457, 6.04250846531031, 2.154897796335098, 4.202856442115502, 4.910720075336861, 3.4997182257274306, 12.578287381359669, 16.716385019866017, 0.489944332509733, 18.480040340638464, 14.721675624912383, 6.882986267345597, 16.531147058362983, 18.807720535358047, 13.023484485884255, 9.00452618690335, 19.809432049381993, 10.08177870990664, 7.871159040734489, 6.453817636017616, 8.025410606324863, 15.93871808115836, 3.24387864168195, 11.202758460233827, 5.081723069907707, 13.803442528146284, 7.294643067001758, 10.471506413903295, 18.7138039406647, 12.735203714365904, 16.092855799999327, 8.891818627180916, 16.9517522804936, 5.043616206419141, 13.056553760974424, 10.014634029680224, 10.65230611262525, 6.579520386725681, 13.829122620965215, 18.613577470574587, 12.101814137654745, 14.32198763991908, 16.374460401074046, 11.416613044688859, 1.876401938453105, 7.106202431468515, 13.11414940634377, 15.67790967070668, 14.426203809857745, 17.97425223468035, 1.8607960762353182, 14.666512010930186, 0.708733430569426, 13.509533784419016, 19.60278399967759, 19.879480037392074, 17.909268786246, 10.105754294952924, 11.16353506286573, 3.7606291797741953, 19.504924243689583, 3.883658907545393, 13.51554677060851, 11.20890987624023, 13.026082482106776, 3.336652011594101, 19.52030479498534, 11.629976960140024, 15.942085615486295, 4.33206483238326, 6.317882394897318, 5.042841813049661, 13.85780176852095, 12.255850996801085, 16.333858153185478, 17.768363726239098, 6.185338004299732, 5.36716389890252, 9.16320081588892, 3.9345251855491292, 2.825735437843784, 11.599054714845105, 4.3614463081189285, 11.046715401735142, 7.6409392978110295, 2.9840220479731405, 3.3134072486440824, 15.3987573420121, 6.097160255921565, 12.273746805527136, 14.465092285609012, 6.4057690770412705, 19.72915330738488, 12.795945558609757, 12.161081621963444, 8.542206440239532, 5.8880873783552525, 9.000705857040456, 13.48046202216734, 9.100789418887134, 16.794653448614003, 11.94925691391086, 2.9344811757373366, 8.813533863992244, 8.711651083149686, 19.1551044312952, 2.3035452828067515, 10.956477925371617, 8.890303120404477, 14.363610363888506, 5.395204787227355, 10.384453025705193, 1.2034367516814726, 2.414956746719812, 9.763302785146774, 16.958788350482493, 11.272039161546841, 9.3465393543114, 10.868516061192196, 11.119265498454268, 8.318519693840894, 9.329442054925092, 16.62616135518237, 13.543386354106232, 12.892617192748073, 14.793543083161513, 14.152170645184425, 15.738852309334295, 18.220458978153687, 9.35886734735086, 17.698576061255025, 18.98204926367094, 14.503331440556924, 10.01531007970234, 17.434669858022204, 14.146341609682723, 17.22917844226306, 12.152249499639257, 15.122166935597527, 15.872458366076806, 18.33118318923495, 5.232109213611769, 2.3567146264931504, 15.542394261167553, 18.744152483510298, 14.036710337623326, 7.48608189214065, 16.957538648827843, 6.4287872485312425, 18.811303478920475, 17.313955746542238, 14.018163431494335, 7.394102309801253, 14.289011871242419, 2.4462856474335215, 17.522175777065186, 13.86803578259304, 2.7153776356327164, 2.985532975755467, 2.7083689298604394, 4.257786527824317, 2.1918379552885248, 3.6465381106801606, 11.037870836457262, 19.9274772563712, 14.486854288278963, 0.05583837903649025, 7.759256585548673, 15.138842630802287, 10.835766694354376, 6.10334663004056, 16.807792688411197, 12.992804031798496, 12.954719404725834, 12.262421758961548, 15.45198781964916, 18.584178702990833, 12.565529552478347, 11.768925783635172, 8.672141730925894, 5.315619335204706, 7.365917094263512, 7.019629407823224, 17.45505910659098, 9.041576479279696, 16.30539721528933, 11.005685202023926, 5.177200624249485, 7.835563480697965, 12.245648694290162, 3.3383898510649357, 9.84247320809336, 7.777392129387094, 11.197009880385272, 3.02924704575229, 12.011275116943146, 17.553363458142936, 2.6940411762624916, 8.557457553678553, 19.186451787291514, 3.0251662979386773, 18.305201728863914, 18.640682564045036, 18.245354237026866, 18.376789976593287, 17.247111637999456, 13.24321987139798, 16.553013142004183, 16.934548511697393, 18.955751212995697, 7.049254040339054, 13.203473548837458, 9.234899443117438, 19.323998134476643, 12.399551697764865, 2.572459629779773, 2.6563358306642186, 13.876358587676243, 12.237195860632326, 11.026970398237086, 11.600261882266224, 15.111996742320951, 2.9314850042337466, 19.099170231891883, 3.655632965432034, 8.534524114678197, 19.574209164154965, 3.425407321120919, 2.1070390981719074, 4.863566683630998, 19.356531231342483, 9.834604614805773, 18.728362231944185, 3.7346616010167843, 15.759222928699234, 5.39204217552816, 2.416901059713976, 19.385485250068616, 4.057232427591355, 7.172667735543065, 13.43320762052588, 4.3469957787999025, 2.4111765289971476, 16.351761286620167, 8.240722846954856, 11.249830986465225, 14.340011721386366, 4.540738282674505, 14.828161782433693, 10.719586539530946, 1.743219009750565, 3.44799976028461, 12.267827079145777, 16.902962586816372, 14.530107968967485, 4.460078999544727, 3.5820963346764834, 3.4667807242271054, 2.9823186989789936, 9.134165678491097, 0.6104579138751198, 9.826083276160988, 17.29690343714389, 11.995807282135695, 16.128499381221694, 4.643297080076334, 3.1445067143477523, 13.629315035530524, 5.904679139837037, 10.37222021215641, 13.37684171492715, 10.961620031118535, 2.596849932723766, 8.428753340403928, 16.60840604742327, 11.87115835671432, 15.074555427383297, 7.480066241406382, 16.100885996005488, 3.291547090876138, 12.115424821472383, 14.722216884523998, 18.839134013922898, 6.224510708307916, 0.07239831839927158, 17.040699921778284, 6.413975626721074, 18.500870841827876, 5.775439453238951, 6.451522152964677, 9.470898915472812, 4.673216964083284, 5.346369562302544, 9.037940472823152, 16.37042200204153, 5.250264484341836, 15.944906421625609, 15.004060909879463, 1.7634049071528146, 14.70233587416158, 6.152145627761488, 10.883766325153095, 12.439804897462253, 4.634456282016156, 13.627760094923422, 14.226307773134595, 11.70548327367144, 14.245758572555427, 14.993998397115178, 18.493992900969108, 17.136412490858305, 15.755692647036541, 5.71140224913635, 2.2962010403176625, 13.996288335598816, 18.2354800121072, 7.309283041165624, 14.053390930285554, 10.606520854535702, 14.227050250199545, 3.75585399039684, 17.70393184764518, 9.650498219967885, 10.352659873944054, 8.016337886677293, 16.56391030250219, 19.081369654659635, 13.900716410380376, 7.087625876395876, 12.004418323357855, 6.21243994206735, 12.87571420468886, 8.92732308486524, 6.3324016847136075, 3.41901485650576, 12.992583571161795, 11.147459935329637, 13.550242036428726, 9.14760520151159, 10.55711757729208, 10.455158013095847, 7.143671729673833, 5.294119518580914, 14.190260796916228, 2.6243144910243177, 8.078472711639558, 2.6581207636762016, 5.437764170925973, 14.47147058535168, 2.3340241891943347, 5.337436251900288, 19.477162688007525, 7.251811405305677, 19.572955246723495, 5.257225791510281, 10.353285422683115, 12.558876853374308, 17.41717574355394, 5.885517791911181, 6.348348974745381, 17.621784009384765, 17.37167170121221, 10.244963539232918, 4.288929773335027, 0.14397218154908575, 17.454105362618538, 13.028002296215094, 8.292966275534887, 19.200072914157214, 19.508670933427183, 1.0686161634760682, 18.0046240321336, 2.2701687347836055, 13.107815880541718, 5.016742255819953, 12.52552289286272, 2.984102732443381, 17.86014279689974, 9.67984182674897, 13.121570378326018, 18.456653329861258, 14.450446168849794, 11.811868740083673, 19.58489873766547, 8.99496493955849, 0.28841596595507113, 16.24208784059921, 12.912719863590286, 19.22936901185666, 8.760129691083513, 8.453316581745513, 13.136250827486169, 13.999254673004573, 18.484199584934387, 19.299357463486025, 17.678651115610183, 2.5591336008868586, 3.7062298004408945, 0.3877424873667934, 19.75578079718611, 9.385967757248384, 8.694428836670253, 18.04835289393672, 18.093906211520597, 10.328424302343864, 4.004534581296754, 17.692686207655058, 11.820345111884052, 19.58656799662409, 15.693635756290584, 16.259370498484607, 18.18035046625496, 6.479385515000489, 14.760096088753926, 11.81915817708162, 6.65028514864225, 7.821292804631126, 8.665699652932089, 15.357893248869663, 12.026453358788592, 13.731620059214668, 13.667341699189857, 8.115910490414937, 11.871503274405521, 4.511133485408019, 17.248406053070035, 18.569487229940602, 19.10453806512467, 0.3143806748918032, 16.237877031979135, 13.915464117403571, 2.7059474085869373, 18.228345866698703, 14.596558513213653, 16.09431667829457, 15.603536364280306, 17.33434708914905, 13.528783552432575, 15.24864182894717, 18.65217241880468, 9.628804067381063, 7.176373981318256, 12.338942673337591, 5.1393912819593845, 13.130999837535125, 10.442983421571938, 18.63289542696773, 7.274818583788408, 4.752493525303613, 4.459004673091728, 4.170248349101334, 10.032194702320815, 12.673326175852752, 15.512403161972616, 17.28044213183928, 17.15343020319472, 12.753979573818409, 8.31980458384809, 1.335424457702421, 4.5315854215383045, 14.071045090694783, 6.521182995296824, 13.922426789618562, 6.502711302267792, 15.81219066515117, 13.318711727108722, 0.8856402217365056, 6.521227611353037, 7.240212958662342, 6.8290634404643535, 9.14058044132835, 12.241018470386077, 6.617296289135188, 1.5750004408841423, 3.4907823426072704, 6.463351037064919, 16.06496148620486, 5.383771419398954, 19.985420644722012, 12.025908543141837, 8.605649481144752, 5.151580461358489, 19.10479483414809, 19.606989846887565, 10.929559911501538, 10.584381152522353, 19.699788602090695, 0.7510781193141902, 2.9674096405814865, 3.043189376025176, 18.469375851936412, 5.509616776247306, 2.18059953976028, 10.53661960746532, 2.2426983391213784, 7.031352567552265, 14.451274751033598, 6.4112591782653805, 18.09031347918127, 9.332413089976137, 16.961493426976297, 5.875542710276998, 19.19493843321205, 17.38641001889803, 10.264658479805995, 15.73190992628849, 17.236490816232312, 6.297242627213747, 15.572389760075527, 8.344534618595327, 12.73521310642779, 6.43764050821132, 15.399679054823139, 10.344013095761976, 13.704104639193954, 14.10949079752453, 3.013742325557377, 11.807982952289912, 16.84983665356353, 4.3299681823585665, 1.4919926348377444, 7.741649801667649, 19.8626173032357, 19.24898045141616, 14.867331453610335, 12.952726892011855, 17.789062458884988, 18.562180167339186, 7.2850838696537785, 6.084431473201775, 0.37535584979146774, 15.671577135488347, 12.456253764147743, 19.988647915405625, 14.477039480217279, 19.71292065767617, 18.055778114445015, 15.72761937618505, 12.062819240921378, 18.545887489399036, 3.145708024383471, 10.21662036482561, 14.249446455604055, 17.60811636125608, 2.834983909908737, 8.989104019604053, 9.53164413539635, 4.886555015989924, 16.05540268788397, 11.936642965528389, 4.894865700063722, 5.027285931803471, 15.712432890624699, 8.21703287270326, 12.291161368800799, 11.47078120202196, 15.997958850264414, 6.215825428038173, 5.615797979934106, 8.739401909638701, 13.471142858999292, 17.52123806667163, 10.989508493445836, 7.74381808673356, 3.0770104962926146, 9.591284840854273, 18.279902301408452, 7.457332889032866, 3.130889023618968, 13.859638788830196, 5.212941601004596, 3.814003623430904, 4.987465022107964, 2.2755858431164735, 8.757021240811671, 9.717930030809347, 10.371990037026352, 2.452192092489811, 17.751709615178072, 14.711353695563918, 12.418771275130316, 18.10664858515011, 14.527243689315533, 16.459155523832457, 9.654652938597014, 19.384537849447582, 19.740490772606655, 12.875425852195512, 13.392216423102566, 13.582104586877758, 5.555044040994739, 19.392154818202442, 18.69601413681742, 4.793911109110375, 3.1411354301460888, 9.318354179378879, 8.220273988494384, 15.031719324380092, 4.830185685991772, 5.947990049272473, 3.4589640577747875, 15.099943297266671, 8.494802872005081, 7.444475946902121, 9.77391457193953, 6.613855831903108, 4.777241168683941, 6.208260002760184, 7.603897083106908, 3.434795038682924, 15.215887502638578, 12.78092810872549, 7.963079243093046, 3.580025560626625, 14.077617054911958, 11.554300533975884, 16.06605036908031, 17.178922282636865, 5.728022553896812, 6.764265502062172, 7.817098954065047, 4.503947592528867, 2.5190338877506036, 8.81597579487071, 18.689585168217334, 11.767338958469358, 5.562333254849299, 5.99524377606642, 9.770510268235215, 3.1652052782117557, 4.750194044368937, 2.1611315856285063, 15.41995135405848, 13.844360893763488, 4.281871189049326, 6.467246265937332, 7.183504028957477, 19.63851249308013, 4.289637673695077, 16.061026411557116, 5.05453458326433, 16.233039988942387, 2.1667217324977424, 7.010564868307725, 10.534033738402496, 6.7580120002949435, 5.587884657581467, 2.119137995480649, 10.675182128286023, 16.170002253421718, 16.45664614113009, 4.75636517976279, 14.790105809510944, 10.54224049761471, 18.26689456739041, 19.507181185950238, 17.190100169038395, 6.835684492920203, 13.829354792600405, 13.236477034444913, 10.229480619602331, 1.387167039857149, 19.0753042583199, 2.350137021640135, 10.642168564808687, 19.467669569891584, 2.538395809677519, 0.9750583165812521, 10.855406925531291, 16.96590050669388, 15.46339009522935, 3.3099589008119534, 10.904866441791594, 0.15476610960290627, 2.8267828954916263, 12.170750729411727, 10.154777625165378, 6.3550114515948515, 10.877164554557087, 0.8678449909135333, 1.2590918358473058, 16.454847003978003, 4.786995536857139, 9.59402902423022, 16.60854476064682, 2.9114825649057874, 0.1707073608923726, 17.42967787302648, 0.37213162651989595, 1.7150221957240808, 15.175412291552657, 10.367964650296933, 17.4666049727629, 12.718383007857181, 0.9484182531839447, 17.076977890178455, 14.97763542473832, 12.005635781529257, 1.4053156119462695, 13.041176225825557, 6.787841583143727, 8.413935036063263, 12.860353570713473, 10.198175811915853, 16.52946580764127, 3.928495796178451, 0.018535361758438285, 13.078030382776317, 4.509116333209068, 3.363943039618522, 5.97478190639928, 16.344364348931716, 13.970448298461458, 10.349183118339603, 13.985075598338875, 16.625103052477673, 2.902630712638694, 11.096255463506216, 17.260209300347114, 9.849256854202995, 5.782503848537477, 10.998180901119559, 19.61255751176519, 3.871382518814121, 15.005147955735325, 12.219866069210303, 14.403859016439247, 15.60261358182232, 18.927831056630442, 5.360187553756591, 14.32138635108037, 0.4377920578620298, 16.531671300870272, 17.955782700798295, 5.534972087364494, 16.840343674996763, 0.02900539718226236, 2.5824814014794084, 4.385331236037554, 8.798399363461957, 10.155583107679881, 5.583213566492541, 14.374925067405439, 16.51164704090958, 6.570223609293619, 15.767866871838262, 7.52775160961318, 5.421582450535982, 9.792875926418239, 19.05278502220232, 9.982032696118093, 19.941238774314588, 14.743129699054897, 12.028063711960227, 15.744712784586685, 7.447722080292829, 17.408815088247366, 15.807620983468862, 14.459132824723701, 5.9812378272216, 13.098451219747409, 9.716332833256248, 6.679147311355136, 14.526838087818167, 18.153706727366906, 19.736721106141527, 11.296120722035521, 8.44066182347962, 19.426608672947673, 18.668325897552055, 17.939473329127274, 19.78540664799871, 4.374313665319165, 9.173556162720121, 2.05710179242848, 0.8600976854232512, 11.876925117227737, 7.893837254800767, 17.611539542741003, 14.681822321919453, 19.805751123204374, 9.361250215018575, 5.754373280527398, 19.741751614899723, 15.934905166764663, 14.899209782105881, 3.0080569632038787, 3.6385483869738255, 9.884860724107785, 15.054117194351708, 1.5248929365647035, 12.544389590793497, 7.718388262480398, 5.453487586734129, 5.176770726044619, 15.333366955131062, 13.14636669382551, 3.9860303434891, 19.68443229401331, 16.0105015900838, 9.340149266515205, 8.950844681118557, 5.650258164158002, 2.1373275748174603, 15.708081306088271, 4.828587683880434, 14.76521809142554, 9.012890120463727, 2.244973333709017, 13.173360313159204, 15.197645018735226, 9.983412831829487, 0.6579762082164664, 16.77858717545317, 14.28254456671327, 18.22089925091311, 9.475840834055393, 12.756485698326287, 10.47786091415272, 4.2044128964227845, 19.56510098464075, 10.152118193487336, 14.131738913470311, 18.331448640119874, 7.986417598992441, 19.58185474573771, 4.409744256344041, 0.13128021969469383, 13.700823739499203, 14.344017628833578, 14.736998363190477, 8.746974559895575, 14.818852940072965, 14.59974547607315, 8.647253624191118, 5.588308636476937, 14.53542527608584, 17.29009188605709, 18.299106410878743, 12.310162889365166, 6.025767455217817, 17.110575146240826, 11.239770562204384, 5.2353337623496685, 18.624268275868697, 8.550727954642985, 4.377439029453728, 8.64574700854555, 2.9288776933148575, 19.673660644317902, 18.413560005216507, 4.181728330452826, 16.840274414566064, 16.573418932259237, 8.695007352639939, 15.866368092887974, 9.695606707272983, 13.86502391292388, 19.502319988645905, 16.209778865556668, 9.395102731346217, 7.736638982655789, 1.5174933150980463, 6.9371279107068995, 15.55189908874516, 4.241704252757927, 3.4392678784663255, 6.374397814747108, 11.20229092175991, 19.84246257837881, 3.6850889575666246, 13.996890758904525, 16.39206777389514, 5.779483465497776, 11.908607388972092, 13.990780175764934, 5.302448817910248, 14.651480969197628, 18.838462818425246, 8.081807798420257, 10.176303276684209, 11.591040936503207, 4.670501029333227, 13.646637860449202, 12.935069575619574, 6.635611038403616, 18.382795178243697, 2.176074187131687, 15.744410634217738, 15.282382739246112, 2.5020763348566355, 15.766906873451324, 19.00055139409066, 11.802871490121179, 13.489822361404185, 3.036361967520862, 6.94377479041838, 15.899404415588261, 17.00050024147888, 10.551545844524092, 14.53202506370155, 6.8184010160432855, 15.216710809811687, 2.747823095732895, 13.038582584332374, 0.7117772071592965, 2.8238597040243456, 14.353679007862617, 15.344566043049813, 5.7760713030135085, 13.501479987872976, 14.468524853136273, 17.754237884870932, 0.30946475890046843, 16.46404204454984, 11.387195636519674, 3.041587839566451, 0.8640647647852862, 16.32828287014059, 14.35023297877941, 14.766766837167255, 5.8210781635913555, 2.014044916571802, 13.730883944521903, 10.446311956569716, 13.37170699761833, 0.787807323797185, 9.86722632358433, 13.594073194419776, 7.822423810553689, 7.422981658769659, 1.8696500858155463, 9.340456666896886, 11.852596043991156, 16.061496914308634, 9.165758143293164, 15.09990275986906, 9.116569921829134, 2.5224948531790647, 16.203556488790184, 9.106152885594456, 8.085926485192985, 7.921643136756337, 9.494283121451392, 13.360583748976309, 19.521255385407862, 13.050320805243615, 5.518036901657757, 11.609782760036785, 16.158245137325906, 14.591603019774944, 15.201718760859395, 8.164580220570015, 5.504660680417748, 8.729883908192544, 19.621710143568322, 15.179017355988352, 7.953545491925243, 14.02411514928951, 11.916216017399963, 11.15333456834237, 9.252487710934323, 11.771545149168926, 13.99994480903955, 0.8578087411106861, 2.5280046165095227, 14.7277510785056, 13.919539384739046, 0.04535327789532362, 13.455672715240855, 18.595512183761045, 4.241690885625447, 13.905122481127412, 12.061961951183724, 11.894578166575613, 9.954369510939449, 19.335560025109682, 8.187704845977251, 19.645642569271033, 3.93099756032814, 1.427604789986896, 11.624910783301058, 14.30995519451872, 5.813827471426746, 9.80057745109385, 2.4792279126905603, 10.152816298396264, 15.62481517013705, 9.527316723584976, 3.7646344654837605, 12.212215636793118, 0.028253302516787482, 0.17656286134492438, 17.549790528912375, 10.215932278116092, 13.227461581997048, 11.04166688028807, 14.423517088761377, 0.12947405054403838, 2.90111736484756, 4.03295887471111, 19.495500420398987, 17.398099005610305, 11.84689302319416, 7.649912969633372, 13.108121453103342, 6.368298404158484, 6.106667424960113, 2.385124135250823, 19.25675590593092, 1.1193458533746514, 5.983208369378509, 9.364120877615, 16.846598796497783, 16.823239676893195, 19.085071377164525, 14.497844674606277, 14.864624712503785, 8.2277143208436, 4.466751456174494, 13.199638388740837, 0.3323641695091739, 11.949292773937906, 11.196700838561949, 14.21575561941201, 7.597874430535687, 19.089552314299436, 5.430862552698644, 5.494333304378307, 8.619013383061304, 9.910635585066768, 5.975979751129989, 6.566730507052929, 18.170035038413232, 13.592509390495026, 2.2909302370088342, 7.122565700597622, 6.742725980578548, 12.20181020703919, 13.780369349297947, 7.098470469221838, 9.028454003608338' 
    ues = list(re.split(r'[,\s]\s*', ue))
    ue = [float(i) for i in ues]
    sig1 = np.load('ue_indoors_sig_for_bs1.npy')
    sig2 = np.load('ue_indoors_sig_for_bs2.npy')
    sig3 = np.load('ue_indoors_sig_for_bs3.npy')
    sig4 = np.load('ue_indoors_sig_for_bs4.npy')
    
    index = 0
    ratio1 = 0
    ratio2 = 0
    ratio10 = 0
    for i in range(500):
        ue_x = ue[index]
        index += 1
        ue_y = ue[index]
        index += 1
        ue_z = ue[index]
        index += 1
        x_est = 0.
        y_est = 0.
        z_est = 0.
        x_list = []
        y_list = []
        z_list = []
        for k in range(10):
            d1 = signal2distance(sig1[i][k], 0)
            d2 = signal2distance(sig2[i][k], 0)
            d3 = signal2distance(sig3[i][k], 0)
            d4 = signal2distance(sig4[i][k], 0)
            dt21 = (d2 - d1) / light_speed
            dt31 = (d3 - d1) / light_speed
            dt41 = (d4 - d1) / light_speed
            position = tdoa_positioning_4bs_improve(bs1, bs2, bs3, bs4, dt21, dt31, dt41, 0, 0, 0, method='taylor-direct')
            if (position.x < 0) or (position.y < 0) or (position.z < 0) or (
                np.isnan(position.x)) or (np.isnan(position.y) or (np.isnan(position.z))):
                continue
            x_list.append(position.x)
            y_list.append(position.y)
            z_list.append(position.z)
        x_est = find_most_average(x_list)
        y_est = find_most_average(y_list)
        z_est = find_most_average(z_list)
        # print('UE REF (%.6f %.6f %6f), Estimate (%.6f %.6f %.6f)' %(ue_x, ue_y, ue_z, x_est, y_est, z_est))
        if (abs(x_est - ue_x) < 1.0) and (abs(y_est - ue_y) < 1.0) and (abs(z_est - ue_z) < 1.0):
            ratio1 += 1
        if (abs(x_est - ue_x) < 2.0) and (abs(y_est - ue_y) < 2.0) and (abs(z_est - ue_z) < 2.0):
            ratio2 += 1  
        if (abs(x_est - ue_x) < 10.0) and (abs(y_est - ue_y) < 10.0) and (abs(z_est - ue_z) < 10.0):
            ratio10 += 1
    print('ratio := %.4f %.4f %.4f' % (ratio1/500, ratio2/500, ratio10/500))
